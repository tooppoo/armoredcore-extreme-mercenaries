# SitemapのETag/TTL最適化（contents_revisions連動 + Conditional GET）: 要求

- 背景: サイトマップ配信で毎回フル生成・フル配信が行われており、クローラ/エッジ/アプリのいずれにも非効率がある。
- 目的: Cloudflare Pages + D1 構成で、Sitemapの更新検知を高精度・低コストにし、Conditional GETで304応答を最大化する。
- 参照: https://github.com/tooppoo/armoredcore-extreme-mercenaries/issues/656

## 利害関係者
- 検索エンジン・クローラ（Googlebot等）
- エンドユーザー（間接的：クロール効率改善→インデックス鮮度向上）
- 運用者（トラフィック・コスト最適化）

## 要求（重視観点: セキュリティ/パフォーマンス/UX/アクセシビリティ/トレーサビリティ）
- パフォーマンス: 
  - ETag/Last-Modified 等の条件付きリクエストを正しく返し、不要な本体転送を削減する。
  - TTL/Cache-Control を、コンテンツ更新に連動させて最適化する（新規/更新時は短め、安定時は長め）。
- トレーサビリティ: 
  - D1の `contents_revisions`（仮名）をソースオブトゥルースとし、サイトマップの最終更新ハッシュ/時刻を一意に算出できること。
  - 監査のため、応答ヘッダやログでバージョン識別子（例: revision hash）を確認可能。
- セキュリティ: 
  - 不必要な詳細情報（内部ID等）をETagに含めない（推測耐性）。
  - 安全なハッシュ（例: SHA-256）を使用、リークしない前提情報のみで算出。
- UX/アクセシビリティ: 
  - XMLサイトマップの仕様に準拠し、エンコーディング・コンテンツタイプ・スキーマを適切化。
  - 大規模時はサイトマップインデックスを維持（既存方針があれば踏襲）。
- 運用性: 
  - wrangler ローカル/本番で挙動が一致すること。
  - 設定はコード化しADRで根拠を残す。

## 成功条件（ハイレベル）
- If-None-Match/If-Modified-Since に対して 304 を正しく返せる。
- 更新がない期間はエッジヒット/本体転送が顕著に減少する。
- 更新発生直後にTTL短縮→再クロール促進→安定後に自動的にTTL延長。
- 監査用に、応答からリビジョン情報を追跡可能。

## 想定制約
- インフラは Cloudflare Pages + D1 固定。
- 既存の `contents_revisions` テーブルスキーマに準拠（変更が必要ならADRで検討）。
- 既存のサイトマップ生成ロジックに接続可能であること。

## オープン課題
- ETagの粒度: 全体ハッシュ vs チャンク/ページ別ハッシュ。
- TTL計算式: 更新頻度に応じた動的TTLの境界値と上限下限。
- 大規模サイトマップ分割時の個別ETag戦略。

