# Ping Bot 通知仕様変更

## 概要
- 目的: 誤検知や情報漏えいリスクを抑えつつ、インシデント対応のトレーサビリティを高める。
- 変更点:
  - 通知内容から「レスポンス本文」を除外する。
  - 通知に「実行URL（GitHub Actions Run URL）」を追加する。

## 背景
- 200/ok でも通知される事象が発生。原因は GitHub Actions の複数行出力の書式不備によるステップ失敗で、`if: failure()` が誤発火した。
- 併せて、レスポンス本文を通知に含めることは、機微情報流出の懸念や可読性低下を招く。

## スコープ
- 対象: Ping Bot の失敗通知（Slack）
- 非対象: Ping の実行条件、スケジュール、Bot 側の挙動変更

## 用語
- Ping: 対象 URL へのヘルスチェック HTTP リクエスト
- 実行URL: `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`

## アクター
- オンコール/運用者: 通知を受け取り、状態を確認して対応する
- GitHub Actions: ジョブ実行・メタデータ提供
- Slack: 通知チャネル

## ユースケース/受け入れ条件
- UC1: 失敗時通知（非200 or ネットワーク失敗）
  - Given: Ping の結果が非200 またはリクエスト失敗
  - When: 失敗通知を送る
  - Then: Slack 通知には `Time`, `Status`, `Message`, `Run URL` が含まれる
  - And: レスポンス本文は含まれない

- UC2: 成功時（200/ok）
  - Given: Ping の結果が 200
  - Then: Slack 通知は送られない

## 機能要件（FR）
1. 通知ペイロードからレスポンス本文を除外する。
2. 通知に GitHub Actions の実行URLを含める。
3. 通知条件は「非200」または「リクエスト失敗」に限定する。
4. `Message` は少なくとも `ok` / `non-200 response` / `curl request failed` のいずれかを取る。

## 非機能要件（NFR）
- セキュリティ: 機微情報（トークン・個人情報・内部URL等）を通知本文に含めない。
- パフォーマンス: 通知組み立ては O(1) で、外部依存を増やさない。
- ユーザー体験: 一目で状態把握可能な最小情報セット（Status/Message/Run URL）。
- アクセシビリティ: Slack Block Kit で見出しとフィールドを構造化、可読性確保。
- トレーサビリティ: 実行URLにより詳細ログへ 1 クリックで遷移可能。

## エラーハンドリング/境界条件
- `Run URL` が生成不可な場合は通知本文から当該項目を省略する（他項目は通知継続）。
- Slack Webhook 未設定時は通知をスキップし、ジョブ自体は成功にする（既存方針踏襲）。

## 影響範囲
- Slack 通知のフォーマット変更のみ。その他のワークフローやアプリケーションコードには影響しない。

## ロールアウト
- スケジュール実行に任せる。必要に応じて `workflow_dispatch` を一時的に付与し、動作確認後に削除。

## モニタリング
- 通知件数、誤検知率の推移を 1〜2 週間観測。必要に応じて通知条件や文言を再調整。

