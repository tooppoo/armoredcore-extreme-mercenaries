# CIにおけるフレーク検知（E2E）

## 概要

- 目的: GitHub Actions の E2E 実行でリトライにより “最終的に成功” しても、フレーク（途中で失敗→再試行で成功）を検知し、ジョブの結果に反映または少なくとも可視化する。
- 方針: リトライ（`retries > 0`）は維持しつつ、フレークが1件でも存在すれば既定では警告に留める（Plan B）。必要に応じて失敗へ切替可能。

## 背景・動機

- Playwright 設定で `retries: process.env.CI ? 2 : 0` となっているため、途中で失敗したテストがリトライでパスするとジョブは成功する。
- これにより不安定なテストの検知が遅れ、UX/信頼性・トレーサビリティが低下する。

## スコープ

- 対象: `.github/workflows/e2e.yml` が実行する E2E（`packages/e2e`）。
- 非対象: ユニットテスト、Lint、その他のワークフロー全般（将来的に拡張可）。

## ユースケース

- ケース1: あるテストが1回目失敗、2回目成功 → フレークとして検知 → 既定ではジョブ失敗。
- ケース2: すべてのテストが初回で成功 → フレークなし → ジョブ成功。
- ケース3: 明らかな恒久的失敗 → ジョブ失敗（従来通り）。

## 検知要件（機能要件）

- Playwright を JSON レポーター付きで実行し、機械可読な結果を生成する。
- JSON レポートから「フレーク」を判定する。
  - 判定基準（いずれかを満たすものをフレークとみなす）:
    - 最終結果が成功で、かつ複数アテンプト（`results`）の中に失敗が含まれる。
    - JSON に `flaky` 指標（バージョンによっては summary や test ごとのフラグ）が存在し、値が true（または `status: 'flaky'` 相当）。
- フレーク数 > 0 の場合、既定では警告のみとしジョブは成功とする。必要に応じて失敗へ切替可能。
- 生成した JSON レポートと HTML レポート（既存の Playwright Report）がアーティファクトとして保存されること。

## 運用要件（非機能要件）

- セキュリティ: レポートに機密情報（トークン、個人情報）を出力しない。必要に応じてスクラビング（マスキング）を行う。
- パフォーマンス: 解析スクリプトはレポート1ファイルをストリーム/単一パスで処理。ジョブ全体の時間増加は数秒以内を目安。
- ユーザー体験: GitHub Actions のアノテーションや要約（`steps.summary`）で、フレーク件数とテスト名を確認できるようにする。
- アクセシビリティ: 失敗理由/該当テスト名を簡潔なテキストで提示（色依存を避ける）。
- トレーサビリティ: JSON レポートおよび HTML レポートを 30 日以上保存。失敗時は Slack/Discord 通知へ将来的に拡張可能な出力を用意。

## 入出力

- 入力: Playwright の JSON レポート（例: `packages/e2e/playwright-report/report.json`）。
- 出力:
  - 解析結果（標準出力/ステップサマリ/アノテーション）
  - 終了コード（0=問題なし、1=フレークあり）
  - アーティファクト: JSON/HTML レポート

## 環境変数/設定

- `FLAKY_POLICY`:
  - `warn`（既定）: フレークありでもジョブ成功（警告のみ）
  - `fail`: フレークありでジョブ失敗
- `PLAYWRIGHT_JSON_PATH`: JSON レポート出力先（未指定時は既定パスを使用）

## 実装方針（概要）

- Playwright 実行時に JSON レポーターを追加（例: `--reporter=github,json=<path>`）。
- レポートを解析するスクリプト（Node.js/TS）を追加し、フレーク判定のうえ終了コードを制御（既定は警告）。
- ワークフローに解析ステップを追加し、最後にアーティファクトをアップロード。
- 解析結果（フレーク一覧）は `GITHUB_STEP_SUMMARY` にも出力して可視化を高める。

## 変更影響

- `.github/workflows/e2e.yml`: レポーター追加、解析ステップ/サマリ出力、アーティファクト保存。
- `packages/e2e`: 必要に応じて `package.json` にレポート出力用のスクリプトを追加（ただし既存の実行フローは保持）。

## リスクと対策

- JSON スキーマ差異（Playwright バージョン差）:
  - 複数の判定条件（`flaky` フラグ or 複数アテンプト混在）を併用し堅牢化。
- レポート肥大化による時間/容量増:
  - レポート保存期間・対象を必要十分な範囲に制限、解析はストリーム処理。
- 誤検知（テスト設計起因）:
  - テスト名・タグでノイズ元を隔離できるように将来的に除外リストを導入可能にする。

## 受け入れ基準

- 既定（`FLAKY_POLICY=warn`）では、フレークが存在してもジョブは成功し、サマリにフレーク件数と該当テストが表示される。
- `FLAKY_POLICY=fail` を設定した場合、フレークが1件でもあればジョブが失敗する。
- レポート（JSON/HTML）がアーティファクトに保存される。
