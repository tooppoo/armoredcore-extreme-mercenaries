# チャレンジ/動画アーカイブ Discord コマンド登録: 要件

## 前提・コンテキスト

- Issue: <https://github.com/tooppoo/armoredcore-extreme-mercenaries/issues/764>
- 要求・シナリオ: `docs/spec/archive/requests.md`, `docs/spec/archive/scenario.md`
- 既存のテキスト書式投稿フローは廃止し、Discord スラッシュコマンド `/archive-challenge` `/archive-video` に統一する
- D1 のスキーマおよび保存処理は既存実装（`packages/front/app/lib/archives/challenge/upload` / `packages/front/app/lib/archives/video/upload`）を継承し、構造を変更しない

## ユーザー種別

- Discord 一般参加者: コマンドを用いてチャレンジアーカイブを登録する
- Discord Bot: コマンド入力を受け取り API に連携、結果をチャンネルへ通知する自動エージェント
- アプリケーション API: Bot からのリクエストを受け付け D1 に保存、重複判定や OGP 取得を行う
- コミュニティ運営・開発者: ログ監査・障害対応・開発者チャンネルでの通知を受け取り対応する

## 情報構造

- 登録データ: 既存の `challenge_archives` / `video_archives` テーブルスキーマを利用し、`title`/`description`/`url`（正規化後）/`upload_member_id` 等を保存
- 追加で保持する必要のあるログ情報（構造化ログ, 通知用データ）:
  - `correlationId`（Discord Interaction ID）
  - `discordUserId` / Discord ユーザー名
  - コマンド入力内容（title, url, description）
  - 重複検知時: 入力 URL（raw）、正規化後 URL、既存レコードの URL
  - エラー時: `errorCode`
- 通知: 500 エラー検知時に Discord 開発者専用チャンネルへメッセージを送る（Bot が投稿する想定）
- 運用: リリース前後に従来のテキスト投稿フロー利用者へ告知し、コマンド利用への移行を促す

## 提供機能

1. `/archive-challenge` コマンド入力 UI のガイド（title 必須→url 必須→description 任意）
2. `/archive-video` コマンド入力 UI のガイド（url 必須→title 任意→description 任意）
3. Bot による API 呼び出しとレスポンス処理
4. 実行チャンネル制限: 許可されたチャンネル以外で実行すると警告メッセージを返す（利用可能チャンネルは環境変数で複数指定可能にする）
5. 成功時・重複時・サポート外 URL 時・コマンド失敗時などのメッセージ表示（日本語のみ）
6. 500 エラー（`failed-get-ogp` / `unknownError` など）発生時のチャンネル投稿（共通文言 + `(コード: xxx)`）と開発者チャンネルへの通知
7. Bot・API 双方で構造化ログを出力し、相関 ID をキーに突合できるようにする

## 利用価値

- 参加者: フォーマット記憶不要で登録でき、心理的負担と入力ミスを削減
- 運営: 重複や非対応 URL を即座に検知でき、ログや通知でトリアージしやすい
- 開発者: 相関 ID と詳細ログで障害調査や監査が可能、500 エラー通知で早期対処ができる

## 国際化 / アクセシビリティ

- 対象コミュニティが日本語限定のため、Discord メッセージは日本語のみとする（i18n 対応はスコープ外）
- コマンドガイドは Discord のネイティブ UI を利用。Bot 応答メッセージはシンプルなテキストで提供し、スクリーンリーダー向け特別対応は不要（既存 UI に準拠）

## 機能要件

- FR1: `/archive-challenge` 実行時、title→url→description（任意）の順で入力を促し、送信すると API へリクエストする
- FR2: `/archive-video` 実行時、url（必須）→title（任意）→description（任意）の順で入力を促し、送信すると API へリクエストする
- FR3: Bot は環境変数で指定されたチャンネル ID のみコマンドを受け付け、その他では「このコマンドは許可されたチャンネルでのみ利用できます」と警告を返す
- FR4: 成功時メッセージは「アーカイブに登録しました」
- FR5: URL 重複時は API からの `duplicated-url` を受け、チャレンジでは「登録済みのアーカイブなので、スキップしました」、動画では「既にアーカイブ済みのURLなのでスキップしました」を返す
- FR6: サポート外 URL 時は「サポート外のURLなのでスキップしました」を返す
- FR7: API 呼び出し失敗時（ネットワーク等）は「アーカイブ追加に失敗しました」を返す
- FR8: 500 エラー（`failed-get-ogp`/`unknownError` など）時は「予期しないエラーが発生しました (コード: {errorCode})」を返し、開発者専用チャンネルへ通知する
- FR9: API から返却された `errorCode` は将来拡張を考慮し Bot 側で任意文字列を扱える
- FR10: description/title 未入力時は API 側で OGP 取得を試み、成功時は不足項目を補完。失敗時は 500 エラーとして扱う

## 非機能要件

- NFR1（ログ・トレーサビリティ）: Bot/ API の構造化ログに `correlationId`・`discordUserId`・コマンド入力内容を必ず出力し、エラー時は `errorCode` を付与。重複エラーでは入力 URL・正規化後 URL・既存登録の URL をログに含める
- NFR2（監視・運用）: 500 エラー発生時に Discord 開発者チャンネルへ通知を送信する。通知には `correlationId` と `errorCode` を含め、一次確認ができるようにする
- NFR3（セキュリティ）: 認可トークンやチャンネル ID、通知先チャンネル ID は環境変数で管理し、ログには秘匿情報を出さない
- NFR4（拡張性）: 許可チャンネルは複数 ID を環境変数などで設定できるようにする（増加を想定）
- NFR5（パフォーマンス）: コマンド応答は Discord のタイムアウト制約内に完了するよう、API 呼び出しは既存実装と同等のタイムアウト/リトライポリシーを継承する

## テスト観点

- テスト1: チャレンジアーカイブでの成功登録（description あり/なし）
- テスト2: 動画アーカイブでの成功登録（title/description あり/なし）
- テスト3: 許可外チャンネルでの警告表示
- テスト4: 重複 URL の場合に Bot メッセージ・ログ内容が規定通りか（チャレンジ/動画）
- テスト5: サポート外 URL でのエラーメッセージ
- テスト6: OGP 取得失敗時に 500 メッセージが一致し、開発者チャンネル通知が行われるか（チャレンジ/動画）
- テスト7: ネットワーク失敗時にコマンド失敗メッセージが返るか
- テスト8: 複数チャンネル設定時の挙動確認

## 今後の検討余地

- 500 エラー通知の閾値設定や再通知ロジック（例: 一定回数以上連続する場合に追加アラート）
- コマンド利用履歴の可視化やレポート化（ダッシュボード等）が必要になった場合の拡張
