# log4brains ツールを専用ワークスペースに隔離する

- ステータス: 承認済み
- 日付: 2025-09-23
- タグ: documentation tooling monorepo

## 背景 / 文脈

`pnpm typecheck` 実行時に `log4brains` が内部依存として持つ React 17 系の型定義がワークスペース全体に波及し、`packages/front` の React 19 互換型と競合した。既存の ADR 管理フローを維持しつつ、型衝突を恒常的に防ぎたい。

## 決定ドライバ

- React 19 / TypeScript 5 環境で型チェックを安定させる必要がある
- ADR 編集・プレビューの運用を継続したい（ツール自体の利用停止は避けたい）
- モノレポ内の依存伝播を抑え、将来の型アップグレード時の影響範囲を限定したい
- 既存ドキュメント配置（`docs/adr`）との整合を維持する

## 検討した選択肢

1. これまで通りリポジトリ直下（ルート）で `log4brains` を管理する
1. `log4brains` の導入を停止し、手動で ADR を管理する
1. `packages/adr` ワークスペースを新設し、`log4brains` をそこでのみ依存解決する（採択）

## 決定（採択）

選択したオプション: "`packages/adr` ワークスペースを新設し、`log4brains` をそこでのみ依存解決する"。理由: ルート依存から切り離すことで React 17 型が共有される問題を解消しつつ、`pnpm` 経由でこれまで通り `log4brains` の CLI を利用できる。既存の `docs/adr` 構造を変更せずに済むため、作業コストとリスクも最小化できる。

## 影響評価

- セキュリティ: CLI 利用時にのみ `log4brains` がインストールされるため、攻撃面が限定される。秘密情報は既存方針通り `docs/adr` では扱わない。
- パフォーマンス: 型チェックのボトルネックを除去し、フロントエンドの開発速度が改善。`pnpm adr` 実行時のみ追加インストールコストが発生する。
- ユーザー体験: ADR 作業者は `pnpm adr new` / `pnpm adr preview` にコマンドを置き換えるだけで従来フローを維持できる。
- アクセシビリティ: ADR 出力位置や Markdown 構造に変更なし。log4brains プレビューの UI も従来通り。
- トレーサビリティ: ADR は引き続き `docs/adr` に集約され、ワークスペース分離で依存関係の追跡が容易になる。

### ポジティブな影響

- 型定義競合が解消され CI/ローカルの `pnpm typecheck` が安定
- `log4brains` を必要とする時だけ依存を読み込むため、他パッケージのアップグレード検証が容易

### ネガティブな影響 / トレードオフ

- `pnpm install` 後に `pnpm adr` を初回実行するまで `packages/adr` の依存がインストールされない（実行時に個別インストールが必要）
- log4brains はカレントディレクトリ直下の設定ファイルを前提とするため、`packages/adr` ではプロジェクトルートから CLI を叩くヘルパースクリプトが必須

## 各選択肢の利点と欠点

### ルートで `log4brains` を管理し続ける

- 良い点: 既存コマンドを変更せずに済む
- 悪い点: React 17/19 の型競合が継続し、`pnpm typecheck` が失敗する

### `log4brains` を廃止し手動管理する

- 良い点: 追加依存がなくなる
- 悪い点: ADR テンプレート生成やプレビューが失われ、必須プロセスの工数が増大

### `packages/adr` ワークスペースを新設する（採択）

- 良い点: 依存の漏れ込みを阻止しつつツールを活用可能
- 良い点: モノレポ構成との親和性が高く、将来的なツール置き換えやアップグレードも局所化できる
- 悪い点: ルートスクリプト (`pnpm adr`) などヘルパー整備が必要

## フォローアップ / 移行計画

- `packages/adr` 専用の `pnpm` スクリプトを維持し、CI や開発ガイドに新コマンドを記載する
- 初回利用者向けに `pnpm install --filter @ac-extreme-mercenaries/adr` を明記し、依存未インストール時のエラーを避ける
- 将来 log4brains が React 19 以降を正式サポートした際も隔離構造は維持し、アップグレード影響を局所化する

## 参考リンク

- [20250911-pnpm-migration-and-ci-hardening.md](20250911-pnpm-migration-and-ci-hardening.md) <!-- モノレポ運用ポリシー -->
