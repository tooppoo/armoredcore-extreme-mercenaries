# ADR: E2E におけるフレーク検知を導入する（初版）

## 日付
2025-09-03

## コンテキスト
- Playwright の `retries` 設定（CI=2）が有効なため、テストが一度失敗しても再試行で成功すればジョブ全体は成功となっていた。
- ログ上は途中で failure が出ているため、開発者が驚く・見落とす・原因追跡が遅れるといった問題が発生した。

## 選択肢
1. CI の `retries=0`（フレークを許容しない）
2. `retries>0` を維持しつつ、フレーク検知でジョブを失敗にする（Plan B）
3. `retries>0` を維持し、フレーク検知はするがジョブは成功（警告のみ）
4. フレーク疑義テストの自動隔離（quarantine）
5. 何もしない（現状維持）

## 状態
- Superseded by: "20250903-change-default-flaky-policy-to-warn.md"（既定ポリシーを warn へ変更）

## 決定（当時）
- 2 を採用（当初案）。つまり、リトライは維持するが、フレークが検知された場合は既定で CI を失敗とする。
- ただし運用上の柔軟性確保のため、`FLAKY_POLICY=warn` を設定した場合は、警告のみに留めてジョブは成功とする。

## 根拠（評価軸）
- セキュリティ: E2E の検知力を維持し、偶然の成功で不具合を見逃しにくくする。
- パフォーマンス: リトライ継続により一時的な異常を救済しつつ、追加の解析は軽量（数秒以内）にする設計とする。
- ユーザー体験: 開発者が「緑だけど実は不安定」を避けられる。ステップサマリとアノテーションで一目で状況を把握可能。
- アクセシビリティ: 過度な色依存を避け、要点をテキストで示す。
- トレーサビリティ: JSON/HTML レポートをアーティファクトとして 30 日以上保存して追跡可能にする。

## 結果としての変更点（概要）
- Playwright を JSON レポーター付きで実行。
- レポート解析ステップを追加し、フレークを検知して可視化する（既定ポリシーは後続ADRで warn に変更）。
- サマリとアーティファクトで検知内容を可視化。

## 却下理由（主な他案）
- 1（`retries=0`）: 厳格すぎる。環境要因の一時的失敗で開発速度が落ちる懸念。
- 3（警告のみ）: 見落としの温床になりやすく、継続的な品質低下を招く恐れ。
- 4（自動隔離）: 仕組みが重く、初期導入コストが高い。まずは検知と失敗の連動から始める。
- 5（何もしない）: トレーサビリティ問題が残存する。

## 影響
- 短期的には、フレークが存在する間は PR の赤率が上がる可能性がある。
- 中長期的には、フレーク修正が進み、CI 安定性と信頼性が向上する。

## フォローアップ
- 実装時は Playwright JSON スキーマ差異に配慮し、複数条件でフレークを判定する。
- 将来的に、テストタグ/除外リスト、Slack/Discord 通知、フレーク履歴ダッシュボードへの拡張を検討する。
