# E2E テストにフレーク検知を導入する（初版）

- ステータス: 廃止（20250903-change-default-flaky-policy-to-warn.md により置換）
- 日付: 2025-09-03
- タグ: CI/CD, Playwright, 品質管理

技術ストーリー: Playwright の再試行機能を維持しつつ、フレーク発生を検知して可視化する方法を検討した初版の方針を記録する。

## 背景 / 文脈

Playwright の `retries=2` を有効にしていたため、一度失敗しても再試行で成功すればジョブ全体は成功になっていた。ログ上では失敗が発生しており、開発者が驚いたり調査が遅れる問題があったため、フレークを検知して可視化する仕組みが必要だった。

## 決定ドライバ

- フレーク発生時に明示的なフィードバックを得たい。
- CI を即座に失敗させるか、警告にとどめるかを柔軟に切り替えたい。
- 現行の `retries` 設定は維持したい。

## 検討した選択肢

1. CI の `retries` を 0 にしてフレークを許容しない。
2. フレーク検知でジョブを失敗扱いにする（Plan B）。
3. フレーク検知は行いつつ、ジョブは成功扱いとする（警告のみ）（採択当時）。
4. フレーク疑義テストを自動隔離する。
5. 何もしない。

## 決定（採択当時）

フレーク検知は行うが、既定ではジョブを成功扱いとし、警告で可視化する運用を採用した。厳格運用が必要な期間やブランチでは `FLAKY_POLICY=fail` を設定して失敗扱いに切り替える方針とした。

## 影響評価

### ポジティブな影響

- フレークの存在を警告で可視化できる。
- 必要に応じて厳格モードへ切り替えられる柔軟性を残せる。

### ネガティブな影響

- 警告のみでは対処が後手に回る可能性がある。
- 設定の切り替えをチームに周知する必要がある。

## 置換情報

- Superseded by: `20250903-change-default-flaky-policy-to-warn.md`
