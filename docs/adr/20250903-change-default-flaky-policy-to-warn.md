# ADR: フレーク検知の既定ポリシーを warn に変更

## 日付
2025-09-03

## コンテキスト
- 既存の Plan B（フレーク検知）は既定で `fail` としていたため、軽微な不安定が多い段階では PR が過剰に赤くなる場面があった。
- 見落としは避けたいが、開発速度やレビュー体験を大きく損ねたくないという要望があった。

## 決定
- 既定の挙動を `warn` に変更する。
  - `FLAKY_POLICY` 未設定時は警告のみ（ジョブ成功）
  - 厳格運用が必要な期間・ブランチでは `FLAKY_POLICY=fail` を設定して失敗扱いに切替可能

## 影響
- ユーザー体験: PR の赤率を抑制しつつ、サマリでフレークを可視化して周知する。
- トレーサビリティ: レポートは引き続き常時保存（`always()`）で確保される。
- セキュリティ/品質: 必要時に `fail` 切替が可能で、品質ゲートを柔軟に運用できる。
- パフォーマンス: 変更なし（解析は軽量のまま）。

## 代替案と却下理由
- 現状維持（既定 `fail`）: 品質は担保しやすいが、開発速度・レビュー体験を阻害しやすい。
- 解析を削除: 問題の可視化が後退し、トレーサビリティが低下する。

## 実装変更
- `.github/workflows/e2e.yml`: `FLAKY_POLICY: ${{ vars.FLAKY_POLICY || 'warn' }}` に更新
- `packages/e2e/scripts/check-flaky.mjs`: 既定を `warn` に更新
- `docs/domain/ci-flaky-detection.md`: 既定を `warn` に更新

