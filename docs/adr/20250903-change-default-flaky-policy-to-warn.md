# フレーク検知の既定ポリシーを warn に変更する

- ステータス: 承認済み
- 日付: 2025-09-03
- タグ: CI/CD, Playwright, 品質管理

技術ストーリー: E2E テストのフレーク検知で PR が過剰に失敗扱いになる問題を解消し、開発速度と可観測性のバランスを取る。

## 背景 / 文脈

Playwright の再試行設定により、テストが一度失敗しても総合結果は成功となるケースが多かった。フレーク検知を `fail` 扱いにしていたため、軽微な不安定で PR が赤くなり、開発体験を損なっていた。

## 決定ドライバ

- フレークを可視化しつつ、開発速度を落としたくない。
- 必要に応じて厳格モード（fail）へ切り替えられる柔軟性を残したい。
- レポートやアーティファクトは継続的に取得し、事後分析を可能にしたい。

## 検討した選択肢

1. 既定を `fail` のまま維持する。
2. 既定を `warn` にしつつ、環境変数で `fail` に切り替え可能とする（採択）。
3. retries を 0 にし、フレークを許容しない運用とする。
4. フレーク検知専用の隔離（quarantine）ワークフローを導入する。

## 決定（採択）

既定ポリシーを `warn` に変更し、`FLAKY_POLICY=fail` を設定した場合のみ失敗扱いとする。これにより平時は開発速度を維持しつつ、必要なタイミングで厳格モードに切り替えられるようにした。

## 影響評価

### ポジティブな影響

- PR の赤率が下がり、レビュー体験が向上する。
- 警告表示とレポート保管により、フレークの可視化は維持される。

### ネガティブな影響

- 厳格モードへの切り替え運用をチーム内で周知する必要がある。
- warn 運用時は失敗扱いにならないため、重大な不安定を見落とさないようモニタリングが必要。

## その他検討事項

- retries を 0 にする案は失敗検知は早いが、CI 再実行が増えるリスクが大きい。
- 隔離ワークフローは実装コストが高く、現段階ではオーバーエンジニアリングと判断した。

## 置換情報

- Supersedes: `20250903-flaky-detection-in-e2e-ci.md`
