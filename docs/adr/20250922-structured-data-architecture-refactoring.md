# メタデータ生成システムの構造化データアーキテクチャリファクタリング

- ステータス: 承認済み
- 日付: 2025-09-22
- タグ: アーキテクチャ, リファクタリング, SEO, 構造化データ, テスト戦略

## 背景 / 文脈

FAQの構造化データが二重になっている問題があり、これを解消するための設計を検討する必要があった。将来的に他の構造化データタイプ（breadcrumb、product、review等）も追加される可能性があり、拡張性を考慮した設計が求められていた。

## 決定ドライバ

- **拡張性**: 新しい構造化データタイプを既存コードに影響なく追加したい
- **保守性**: 各構造化データタイプのロジックを独立してメンテナンスしたい
- **テストの管理性**: テストが肥大化することを防ぎたい
- **型安全性**: TypeScriptによる厳密な型チェックを維持したい
- **後方互換性**: 既存の使用箇所への影響を最小化したい

## 検討した選択肢

1. **buildMetaにFAQオプション追加**: `buildMeta`関数にFAQオプションを追加し、同様のパターンで他の構造化データも追加していく
2. **個別関数アプローチ**: 各構造化データ用の独立した関数を作成し、各ページで手動組み合わせ
3. **レイヤー化アーキテクチャ**: 構造化データ専用モジュールを分離し、統合処理と組み合わせる

## 決定（採択）

選択したオプション: "レイヤー化アーキテクチャ"。理由: 拡張性、型安全性、テスト管理性のすべてを同時に実現でき、既存コードへの影響も最小限に抑えられるため。

## 影響評価

- セキュリティ: 影響なし。構造化データ生成ロジックの分離により、セキュリティリスクは変更されない
- パフォーマンス: わずかな改善。不要な構造化データ処理をスキップする条件分岐により効率化
- ユーザー体験: 影響なし。生成されるメタデータの品質は維持される
- アクセシビリティ: 向上。構造化データの適切な生成により検索エンジンでの発見性が改善
- トレーサビリティ: 向上。各構造化データタイプのテストが分離され、問題の特定が容易になる

### ポジティブな影響

- **開発効率の向上**: 新しい構造化データタイプの追加が簡単になる
- **コード品質の向上**: 単一責任原則の遵守により、各モジュールの責任が明確化
- **テスト保守性の向上**: 構造化データ別のテスト分離により、テストの肥大化を防止
- **型安全性の強化**: オーバーロードによる段階的移行で既存コードとの互換性を保持

### ネガティブな影響 / トレードオフ

- **初期複雑性の増加**: ファイル数の増加により、初見での理解コストがわずかに上昇
- **学習コストの増加**: 新しいアーキテクチャの理解が必要

## 各選択肢の利点と欠点

### buildMetaにFAQオプション追加

`buildMeta`関数にFAQオプションを追加し、同様のパターンで他の構造化データも追加していくアプローチ。FAQの構造化データ重複問題を解決する最も直接的な方法。

- 良い点: 実装が簡単で直接的
- 良い点: 既存コードへの変更が最小限
- 良い点: 学習コストが低い
- 悪い点: 新しい構造化データタイプごとに関数が肥大化
- 悪い点: テストが単一ファイルに集中し、保守性が低下
- 悪い点: 単一責任原則に違反

### 個別関数アプローチ

各構造化データタイプ用の独立した関数を作成し、各ページで手動組み合わせするアプローチ。

- 良い点: 各構造化データタイプのロジックが完全に分離
- 良い点: 関数の責任が明確
- 良い点: テストが自然に分離される
- 悪い点: 呼び出し忘れのリスク
- 悪い点: 各ページでのボイラープレートコードの増加
- 悪い点: DRY原則に違反する可能性

### レイヤー化アーキテクチャ

構造化データ専用モジュールを分離し、統合処理と組み合わせるアプローチ。

- 良い点: 拡張性と保守性を両立
- 良い点: 型安全性を保ちながら段階的移行が可能
- 良い点: テストの分離により肥大化を防止
- 良い点: 統一されたAPIによりDRY原則を維持
- 悪い点: 初期実装の複雑性
- 悪い点: ファイル数の増加

## フォローアップ / 移行計画

1. **段階1**: 新しい構造化データアーキテクチャの実装
   - `structured-data/` モジュールの作成
   - FAQ用の実装とテストの分離
   - 既存の `buildMeta` 関数のリファクタリング

2. **段階2**: 既存使用箇所の更新
   - `routes/index.tsx` での新APIの採用
   - 後方互換性を保ったオーバーロードの実装

3. **段階3**: テスト階層化の完了
   - 統合テスト、個別機能テスト、組み合わせテストの分離
   - テストヘルパーとモックデータの整備

4. **段階4**: ドキュメント化
   - アーキテクチャ概要の文書化
   - 新機能追加手順の明文化
   - 設計原則の記録

## 参考リンク

- [packages/front/app/lib/head/README.md](../../packages/front/app/lib/head/README.md) - 実装されたアーキテクチャの詳細ドキュメント
