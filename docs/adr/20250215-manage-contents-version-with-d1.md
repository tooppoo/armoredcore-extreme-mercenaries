# リビジョン番号によるETag管理をCloudflare D1で行う（数値カウンタ方式）

- ステータス: 承認済み
- タグ: ETag 管理, Cloudflare D1, リビジョン番号

技術ストーリー:  
動的コンテンツの一覧ページにおいて、効率的かつ一貫性の高いキャッシュ制御（ETag更新）を実現するためのリビジョン番号管理方式を決定する。加えて、リビジョン番号の形式として数値カウンタを採用する。

## 背景と問題の説明

頻繁に更新が行われるページにおいてキャッシュを有効活用するため、ETagを適切に更新して304レスポンス（Not Modified）を返す仕組みを導入したい。その際、個別のリソースではなく一覧ページ全体が更新されるケースもあり、ページ全体の更新タイミングを示す「リビジョン番号」が必要となる。  
さらにリビジョン番号のフォーマットとして、数値（integer）やUUID (v7) などの候補があるが、運用や実装のしやすさを考慮して最終的な形式を決定する必要がある。

## 決定要因

- 更新時の整合性を確実に担保したい  
- データベースでの書き込み（INSERT/UPDATE/DELETE）とリビジョン番号の更新を同じトランザクションで実行したい  
- Cloudflare KVなどを利用する場合は整合性やアトミックなインクリメントが難しくなる  
- リビジョン番号の形式はシンプルかつ比較が容易であることが望ましい

## 検討した選択肢

1. Cloudflare D1 の専用テーブルで数値カウンタ（integer）を管理する
2. Cloudflare D1 の専用テーブルで UUID（特にUUID v7）を使う
3. Cloudflare KV でリビジョン番号を管理する
4. 同じテーブルにリビジョン番号カラムを追加する  
   （既存テーブルに `revision` カラムを設ける）

## 決定結果

選択したオプション: 「Cloudflare D1 の専用テーブルで数値カウンタ（integer）を管理する」  
その理由は、更新時のトランザクション管理が簡易かつアトミックに実行でき、整合性を高められるうえ、**数値カウンタのインクリメント方式が最もシンプルに運用できる**ため。  
UUID v7 に比べて、比較演算が容易（`revision_number_A > revision_number_B` など）で、オーバーヘッドが小さい点もメリットとなる。

### ポジティブな影響

- アプリケーションコードで `UPDATE ... SET revision_number = revision_number + 1` とするだけで整合性を維持できる
- ETag用に取得する際はごく軽量なSQLクエリで済む
- 数値の大小比較が単純なので、古い/新しいの判定が容易

### ネガティブな影響

- (ほぼ考えにくいが) 長期運用で極端にリビジョン番号が大きくなると、整数の上限に近づく可能性がある  
  → 64bit整数を使えば実質問題ない
- 大量の同時更新時には競合が起き得るが、トランザクション管理で対処可能

## 各選択肢の利点と欠点

### 選択肢1: Cloudflare D1 で数値カウンタ（integer）を管理

- 良い点: トランザクションを活用でき、整合性を保ちやすい  
- 良い点: 数値インクリメントがシンプルかつ軽量で、古い/新しいの判定が直感的  
- 悪い点: 同時更新が極端に多い場合はロックやトランザクション衝突への考慮が必要

### 選択肢2: Cloudflare D1 でUUID (v7) を管理

- 良い点: 一意性と時系列性が担保されるため衝突を起こしにくい  
- 良い点: 分散サービスとの連携やログ識別子としても使いやすい  
- 悪い点: インクリメントの概念がなく、比較ロジックを工夫する必要がある  
- 悪い点: 整数よりも記憶・比較コストがやや高い

### 選択肢3: Cloudflare KVでリビジョン番号を管理

- 良い点: グローバルレプリケーションにより読み取りが高速  
- 良い点: シンプルにキー・バリュー操作が可能  
- 悪い点: 同時更新をアトミックに扱う仕組みが標準ではなく、整合性確保が難しい  
- 悪い点: データベースの更新と同期を取るための実装が煩雑

### 選択肢4: 同じテーブルにリビジョン番号カラムを追加

- 良い点: 専用テーブルを増やさずに済むため、一見シンプル  
- 良い点: 更新のたびに同テーブル上で直接インクリメントを行える  
- 悪い点: 大規模な一覧など、リソースを追加で増やす場合に柔軟性に乏しい  
- 悪い点: 個別リソースと一覧リソースを区分した運用が煩雑になる場合がある

## リンク

- [Cloudflare D1 Document](https://developers.cloudflare.com/d1/)
- [UUID v7 Draft Specification](https://datatracker.ietf.org/doc/html/draft-ietf-uuidrev-rfc4122bis-00)
- [ULID Specification](https://github.com/ulid/spec)
