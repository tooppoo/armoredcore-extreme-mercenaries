# リビジョン番号によるETag管理をCloudflare D1で行う

- ステータス: 承認済み
- タグ: ETag 管理, Cloudflare D1, リビジョン番号

技術ストーリー: 動的コンテンツの一覧ページにおいて、効率的かつ一貫性の高いキャッシュ制御（ETag更新）を実現するためのリビジョン番号管理方式を決定する。

## 背景と問題の説明

頻繁に更新が行われるページにおいてキャッシュを有効活用するため、ETagを適切に更新して304レスポンス（Not Modified）を返す仕組みを導入したい。その際、個別のリソースではなく一覧ページ全体が更新されるケースもあり、ページ全体の更新タイミングを示す「リビジョン番号」の管理方法を明確にする必要がある。

## 決定要因

- 更新時の整合性を確実に担保したい
- データベースでの書き込みとETag(リビジョン)管理を同じトランザクションで実行したい
- Cloudflare KVは最終的整合性でありアトミックな更新が行いにくい
- 高頻度の更新が想定されるため、競合や整合性崩れを最小化したい

## 検討した選択肢

1. Cloudflare D1 でリビジョン番号を専用テーブルに保持する
1. Cloudflare KV でリビジョン番号を保持する
1. 同じテーブルにリビジョン番号カラムを追加する

## 決定結果

選択したオプション: 「Cloudflare D1 でリビジョン番号を専用テーブルに保持する」。  
その理由は、**更新時のトランザクション管理が簡易かつアトミックに実行できる**ため。KVでの競合制御に比べて実装がシンプルであり、後々の拡張性（複数の一覧や複数リソースの対応）にも柔軟に対応できる。

### ポジティブな影響

- 更新とリビジョン番号インクリメントを同一トランザクションで実行可能
- DB整合性を高め、ETagに齟齬が生じるリスクを下げられる
- 後続で同様の要件が発生しても専用テーブルを拡張するだけで対応しやすい

### ネガティブな影響

- KVに比べるとリビジョン番号の参照速度が若干遅い可能性がある（ただし多くのアプリでは許容範囲）
- D1へのクエリが増えることに伴う運用コスト（クエリ料金等）の増加

## 各選択肢の利点と欠点

### 選択肢1: Cloudflare D1でリビジョン番号を専用テーブルに保持する

- 良い点: トランザクションが使え、整合性が取りやすい
- 良い点: リソース別に`(resource, revision_number)`管理が可能で拡張性が高い
- 悪い点: KVに比べると読み出し速度やレプリケーションによる高速化の恩恵は限定的

### 選択肢2: Cloudflare KVでリビジョン番号を保持する

- 良い点: グローバルにレプリケートされ、読み出しが高速
- 良い点: 単純なキー・バリュー操作で実装しやすい
- 悪い点: 最終的整合性であり、同時更新時にアトミックにインクリメントしづらい
- 悪い点: 大量の更新が重なると競合処理が複雑になり実装コストが上がる

### 選択肢3: 同じテーブルにリビジョン番号カラムを追加する

- 良い点: テーブルが1つで済むためシンプルに見える
- 良い点: INSERT/UPDATE/DELETE のタイミングで同じ行を更新できる
- 悪い点: 「複数の一覧」にまたがる場合や、リソース単位でバージョンを分けたい場合に柔軟性が下がる
- 悪い点: カラム設計における将来的な影響が読みづらくなる

## リンク

- [Cloudflare D1 Document](https://developers.cloudflare.com/d1/)
- [Cloudflare KV Document](https://developers.cloudflare.com/workers/runtime-apis/kv/)
