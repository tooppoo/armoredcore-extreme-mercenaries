# Cloudflare D1 で数値カウンタのリビジョン管理を行う

- ステータス: 承認済み
- 日付: 2025-02-15
- タグ: ETag, Cloudflare D1, キャッシュ制御

技術ストーリー: 一覧ページのキャッシュ制御を効率化するために、ETag 更新を担うリビジョン番号の管理方式を決定する。

## 背景 / 文脈

コンテンツ一覧ページで 304 応答を適切に返すため、ページ全体の更新タイミングを示すリビジョン番号を管理したい。Cloudflare Pages + D1 を用いる構成下で、どのストレージにどの形式でリビジョンを記録するかが課題だった。

## 決定ドライバ

- 更新時の整合性を確実に担保し、トランザクション内でリビジョン番号を更新したい。
- Cloudflare KV ではアトミックなインクリメントが難しく、一貫性の確保が課題となる。
- リビジョン番号の形式は比較しやすく、実装がシンプルなことが望ましい。

## 検討した選択肢

1. Cloudflare D1 に数値カウンタを保持し、更新時にインクリメントする（採択）。
2. Cloudflare KV にリビジョン番号を持ち、ワーカー側でインクリメントする。
3. UUID (v7) などの時系列識別子を利用する。
4. 各レコードの更新日時を都度走査し、一覧の最終更新時刻を算出する。

## 決定（採択）

Cloudflare D1 に数値カウンタを保持し、コンテンツ更新トランザクション内でインクリメントする方式を採用する。D1 の ACID 特性を活かして整合性を確保しつつ、比較と実装が容易な整数で管理できる。

## 影響評価

### ポジティブな影響

- データ更新とリビジョン更新を同一トランザクションで扱え、整合性が高まる。
- 整数比較が簡単で、ETag/If-None-Match を扱う実装がシンプルになる。

### ネガティブな影響

- D1 のスキーマ管理やマイグレーションが必須となる。
- 分散リージョンでの同時更新に備えたロック設計が必要。

## その他検討事項

- KV を用いる案はアトミック更新が難しく、整合性確保コストが高かった。
- UUID 方式は一意性は高いが、比較ロジックが煩雑になりやすい。
