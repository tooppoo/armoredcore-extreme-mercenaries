# アーカイブ削除リクエストの中間テーブル方式

- ステータス: 承認済み
- タグ: [アーキテクチャ, テーブル設計, 削除リクエスト]

技術ストーリー: アーカイブ(動画テーブル / チャレンジテーブル) を分割する方針の中で、削除リクエストをどのように設計・管理すべきかを検討。

---

## 背景と問題の説明

動画・チャレンジのどちらにも適用される削除リクエストを、一括で管理したい。  
しかしアーカイブテーブルは分割されているため、動画用かチャレンジ用かを区別しながらも、削除リクエストを横断的に集約したいという要件がある。  
DB上で「削除リクエスト」というドメインオブジェクトをどのように表現するかが問題となっている。

---

## 決定要因

- **横断的な削除リクエストの閲覧・集計ニーズ**: 種別を問わず、すべての削除リクエストを一覧したい。  
- **外部キー制約の利用**: アプリケーションロジックだけでなく、DBレベルでも整合性を保ちやすい方法を重視。  
- **拡張性**: 将来的に「1つの削除リクエストで複数の動画やチャレンジをまとめて削除申請する」「別種のアーカイブが増える」などの可能性がある。

---

## 検討した選択肢

1. 単一テーブルを使用し、`archive_type` + `archive_id` を持たせる（ポリモーフィックカラム方式）  
2. 種類ごとの削除リクエストテーブルを分割（動画用 / チャレンジ用）  
3. 削除リクエスト本体テーブル + 中間テーブルで動画/チャレンジを紐づけ（中間テーブル方式）

---

## 決定結果

選択したオプション: 「3. 削除リクエスト本体テーブル + 中間テーブルで動画/チャレンジを紐づけ」  
理由は、削除リクエストを一元管理しつつ、外部キー制約を厳密に活用できるため。また、複数のアーカイブをまとめて1つのリクエストに紐づけるなど、将来的な拡張にも柔軟に対応できる。

### ポジティブな影響

- 削除リクエストの共通情報（理由・ステータス等）を一括管理できる。  
- アーカイブの種類が増えても、中間テーブルを追加する形で対応しやすい。  
- 外部キーで動画テーブル・チャレンジテーブルを厳密に参照できるため、データの整合性管理が明確。

### ネガティブな影響

- テーブル数・JOINが増え、実装とクエリが複雑になりがち。  
- 小規模の場合はオーバーエンジニアリングになる可能性がある。

---

## 各選択肢の利点と欠点

### 選択肢1: 単一テーブル (ポリモーフィックカラム方式)

- 良い点:  
  - 削除リクエストテーブルが1つだけで済むためシンプル。  
  - `archive_type` + `archive_id` という構造で「動画/チャレンジ」を区別しやすい。  
- 悪い点:  
  - DBで外部キー制約を設定しにくい。  
  - 種類が増えるほど `archive_type` の管理や分岐が増加。

### 選択肢2: 種類ごとの削除リクエストテーブルを分割

- 良い点:  
  - 動画用、チャレンジ用それぞれに外部キーを貼り、スキーマ上わかりやすい。  
  - 管理ロジックも種類ごとに切り分けられる。  
- 悪い点:  
  - 「動画 + チャレンジ」をまたぐ横断的な管理が難しく、UNION などが必須。  
  - テーブルが増え、同様のロジックを重複実装する場合が多い。

### 選択肢3: 削除リクエスト本体 + 中間テーブル方式 (今回の採択)

- 良い点:  
  - 削除リクエストという1つのエンティティで共通管理ができる。  
  - 外部キー制約を子テーブルに対して厳密に付与しやすい。  
  - 将来、複数アーカイブを1つのリクエストに紐づけるなど拡張が容易。  
- 悪い点:  
  - 実装・DB設計が複雑になり、INSERT/UPDATE 時に複数テーブルの操作が必要。  
  - 小規模用途ではオーバーエンジニアリングになるリスク。

---

## リンク
