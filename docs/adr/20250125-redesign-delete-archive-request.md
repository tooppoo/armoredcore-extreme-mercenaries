# アーカイブ削除リクエストを中間テーブルで管理する

- ステータス: 承認済み
- 日付: 2025-01-25
- タグ: アーキテクチャ, テーブル設計, 削除リクエスト

技術ストーリー: 種別ごとに分割したアーカイブテーブル上で、削除リクエストを横断的に管理できるスキーマを決定する。

## 背景 / 文脈

動画・チャレンジの両方に対して削除リクエストを受け付けたいが、アーカイブテーブルは種別ごとに分割されている。単一の削除リクエストを複数種別へ紐づけたい、DB レベルで整合性を担保したいといった要求があり、どのようなモデリングが最適かを検討した。

## 決定ドライバ

- 種別横断で削除リクエストを一覧・集計したいニーズがある。
- 外部キー制約を活かして、データ整合性を DB レベルで担保したい。
- 将来的に 1 件の削除リクエストで複数のアーカイブを対象にしたり、新しいアーカイブ種別が増える可能性がある。

## 検討した選択肢

1. 削除リクエストを単一テーブルに置き、`archive_type` と `archive_id` を持たせる（ポリモーフィックカラム）。
2. 種別ごとに削除リクエストテーブルを分割する（動画用 / チャレンジ用）。
3. 削除リクエスト本体テーブルと中間テーブルを用意し、動画・チャレンジを中間テーブルで紐づける（採択）。

## 決定（採択）

削除リクエスト本体 + 中間テーブル方式を採用する。共通情報は本体テーブルで一元管理しつつ、中間テーブルに外部キーを貼ることで種別ごとの整合性を担保でき、アーカイブ種別の増加にも柔軟に対応できる。

## 影響評価

### ポジティブな影響

- 削除リクエストの共通情報（理由・ステータス等）を 1 か所で管理できる。
- 将来的にアーカイブ種別が増えても、中間テーブルを追加するだけで拡張しやすい。
- 外部キー制約により、動画/チャレンジとの参照整合性を DB が保証できる。

### ネガティブな影響

- テーブル数と JOIN が増え、実装とクエリが複雑になりやすい。
- 小規模な用途ではオーバーエンジニアリングと感じられる可能性がある。

## その他検討事項

- ポリモーフィックカラム方式はテーブルが 1 つで済むが、外部キー制約を貼れず整合性をアプリ側で担保する必要がある。
- 種別ごとの専用テーブル方式は単純だが、横断集計が困難でロジックが重複しやすい。
