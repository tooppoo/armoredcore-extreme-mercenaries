# AIエージェント向け指示

## 核心原則（10秒で理解）

**MUST**: 日本語、セキュリティファースト、構造化ログ、型安全性、例外処理
**SHOULD**: UDD>DDD>TDD、可逆性優先、パフォーマンス測定、テスト80%
**MAY**: ***ADR***記録、monorepo、監視・メトリクス
**NEVER**: 本番操作、Secrets出力、無断依存追加

## 要約

このドキュメントは個人でのアプリケーション開発における包括的な指針を定めています。

## 核心原則（優先度順）

### MUST（必須要件）

- **日本語使用**：すべてのやり取りは日本語、Markdown形式で出力
- **セキュリティファースト**：最小権限の原則、依存バージョン固定、機微情報保護
- **構造化ログ**：info/debug/warn/error/fatalレベルの遵守、機微情報除外
- **型レベルプログラミング**：Parse don't validate原則、静的型解析の活用
- **例外処理**：エンドユーザーが解決不可能な問題のみ例外、それ以外はResult型

### SHOULD（強く推奨）

- **開発スタイル**：UDD > DDD > TDD の優先度
- **設計原則**：可逆性 > 低結合 = 高凝集 = 直交性 > KISS = YAGNI > DRY
- **アーキテクチャ**：ポリシーと実装の分離、生成と実行の分離、依存の一方向性
- **テスト**：カバレッジ80%以上、自動テスト優先、手動テスト手順書作成
- **パフォーマンス**：客観的指標による測定、基準値の継続監視、ユーザー体験優先

### MAY（推奨）

- ***ADR***作成：重要な意思決定の記録
- **monorepo構成**：packages/以下にパッケージ配置
- **監視・メトリクス**：観測可能性確保、軽量監視、アラート設定

### NEVER（禁止）

- 本番環境操作、Secrets出力、無断依存追加、mainブランチ直接push

## クイックリファレンス

### 迷った時の判断基準

- **曖昧な要求** → 確認を求める（推測禁止）
- **セキュリティ疑問** → 最小権限、機微情報除外を優先
- **パフォーマンス疑問** → 測定可能な基準値で判断
- **例外 vs 失敗** → ユーザーが解決できない→例外、解決可能→Result型

### 即座参照情報

- **用語定義**：docs/terms.md、太字斜体で表記
- **命名規則**：docs/naming.md（リポジトリ横断。サブディレクトリ固有は各配下のAGENTS.mdで補足）
- **テスト配置**：実装と同じディレクトリ
- **ログ出力**：JSON形式の構造化ログ、機微情報除外
- **監視項目**：可用性、性能、ユーザー体験、/healthエンドポイント

---

## 詳細: MUST（必須要件）

### 基本ルール

- ドキュメント・回答・コメントなど、すべてのやり取りは日本語を使用する。
- 出力は **Markdown形式** とする。
- コードやdiffを提示する場合も、必ずMarkdownコードブロックで囲む。
- 曖昧または矛盾する要求に対しては、推測で対応せず、**確認を求める**こと。

### セキュリティ

- **最小権限の原則**を適用する：システム、アプリケーション、ユーザー、プロセス、ワークフローなど、あらゆるコンポーネントには必要最小限の権限のみを付与する。
- **依存バージョンの固定**：新しい依存を追加する際は、特定のバージョンを明示的に指定する。
- **依存追加の承認手順**：新しい依存が必要になった場合は作業中に「この依存が作業に必要だが、このバージョンで追加して良いか？」と確認し、明示的な承認を得てから導入する（Issueの作成は不要）。
  - 承認時のチェック項目は `docs/checklist/add-dependency.md` を参照する。
- 構造化ログを出力する際、機微情報は決して含めないこと（例：認証情報、個人情報、金融データ、知的財産）
- 不要な依存追加を禁止する。

### ログ

- 構造化ログを用いること
- 構造化ログには不具合・障害調査にあたって必要とされる情報を含めること
- ログレベル遵守：
  - **info**：システムの正常動作における重要な出来事（例：サービスの起動・停止、バッチジョブの起動・終了、主要なAPIの呼び出し）
  - **debug**：開発者が特定機能やパスの実行経路を追跡するために有用な情報（例：メソッド呼び出しの前後状態、パラメータ、リクエスト/レスポンス本文）
  - **warn**：システム上期待された動作ではないが、処理は実行可能なもの（例：非推奨APIの呼び出し、リソースの閾値超過、期待しない入力値）
  - **error**：システム上期待された動作でなく、処理を中断させなくてはならないもの（例：未処理の例外発生、外部APIの呼び出しエラー）
  - **fatal**：システム上期待された動作ではなく、システム全体の動作を止めるもの（例：必須設定の取得失敗、必須DBへの接続失敗）

**実装例:**

```typescript
// ✅ 構造化ログの実装例
const logger = {
  info: (message: string, context: Record<string, unknown> = {}) => {
    console.log(JSON.stringify({
      level: 'info',
      timestamp: new Date().toISOString(),
      message,
      ...context,
      // 機微情報は含めない
    }));
  }
};

// 使用例
logger.info('User operation completed', {
  userId: user.id, // OK: 識別子
  operation: 'profile_update',
  duration_ms: 150,
  // password: user.password, // NG: 機微情報
});
```

### 用語の取り扱い

- プロジェクト固有の用語を導入する場合は、専用の用語集を作成すること。
- 用語集は `docs/terms.md` に配置する。
- ドキュメントやコメントで独自用語を使用する場合は、***太字斜体*** で装飾すること。
- `docs/terms.md` で定義されている用語は必ず***太字斜体***で表記すること。
- 定義されていない用語を使う必要がある場合は、まず確認を求める。
- 新しい用語を追加する場合は、`docs/terms.md` の「用語の追加・更新について」セクションに従うこと。

### 例外処理

- **例外の基準**: エンドユーザーが自力で解決できない問題のみ例外とする
- **失敗の表現**: ユーザーが解決可能な問題はResult型で「失敗」として表現
- **ログ出力**: 例外発生時はerrorまたはwarnレベルでログ出力

**判断例**: 空の入力値→Result型、DB接続断→例外

### 型レベルプログラミング

- **静的型解析の活用**: 実行時ではなく型解析レベルで入力値の妥当性を判定
- **Parse don't validate**: バリデーション後も型安全性を保持
- **ブランド型の活用**: 文字列や数値に意味的な型安全性を付与

**アプローチ**: validate（事後チェック）ではなくparse（型変換）を使用

## 詳細: SHOULD（強く推奨）

### 開発スタイル

- TDD（Test-Driven-Development）
- UDD（UseCase-Driven-Development）、特にドキュメンテーション
- DDD（Domain-Driven-Design）、特にドキュメンテーション、アプリ設計、ディレクトリ構成、クラス・関数・モジュールの命名
- 開発スタイルが衝突した場合は、**UDD > DDD > TDD** の優先度で判断する。

### アーキテクチャ方針

- **ポリシーと実装の分離**
- **生成と実行の分離**
- **依存の方向**：依存は常に一方向とすること。相互依存は禁止
- **開放閉鎖原則**：各モジュールは、拡張が容易となるように作ること

#### レイヤリングと配置

- ルール優先順位: 「レイヤーが違ったら別ディレクトリ」 > 「関連が強いものは物理的に近く」。
- レイヤー例（一般化）: entrypoint / adapters / application / domain / infrastructure（名称はプロジェクトに合わせてよい）。
- 異なるレイヤーのコードは物理的に分離する（別ディレクトリに置く）。近接配置は同一レイヤー内でのみ最適化する。
- 依存は高次→低次の一方向（上位が下位へ）。上位レイヤーは下位レイヤーの詳細に依存せず、抽象に依存する。
- 例: HTTPエンドポイントや関数エントリポイント（entrypoint）と、バリデーション/ユースケース（application）や永続化（infrastructure）は別ディレクトリに配置する。

### 仕様定義プロセス

1. 要求定義：`docs/spec/templates/_requests.md` を用い、背景・目的・利害関係者・制約・成功基準を明文化し、承認者の合意を得る。曖昧な点は必ず依頼者に確認して解消する。
2. シナリオ定義：`docs/spec/templates/_scenario.md` を参照し、ペルソナ、前提条件、トリガー、基本/代替フローを洗い出して要求の目的と整合するかレビューする。ギャップがあれば要求定義に差し戻す。
3. 要件定義：`docs/spec/templates/_requirements.md` を使用し、機能・非機能要件、受け入れ基準、テスト観点、依存・制約、設計メモを整理する。シナリオを満たせているか確認し、承認を得るまで次工程へ進まない。
4. ユースケース定義：`docs/spec/templates/_usecase.md` を用い、アクターとユースケース一覧を作成し、各基本/代替フローを具体化する。要件定義と齟齬があれば差し戻し、テスト設計（***UDD*** > ***DDD*** > ***TDD***）の基盤を整える。

各工程は出力物の自己レビューおよび承認を完了させてから次に進み、後工程での変更が発生した場合は上流工程へフィードバックして一貫性を維持する。

### 設計方針

- 優先度：`可逆性 > 低結合 = 高凝集 = 直交性 > KISS原則 = YAGNI > DRY原則`

### テスト

- 自動テストのカバレッジは80%以上を必ず維持し、90%以上を目標とする
- 単体テストは実装と同じディレクトリに配置する。spec/ など別ディレクトリには分離しない
- e2eテストは独立したパッケージとする。他パッケージからの import を禁止する。
- **手動テスト**：自動テストが適正でない場合は、手順書を作成する（`docs/test` ディレクトリに作成）

### 実装方針

- **Fail Fast**：前提条件が満たされていないために失敗する時は、可能な限り素早くエラーにして発見を早める
- **少ない・浅い分岐**：分岐はできるだけ減らし、コードが線形となるようにする

### コメント記述ガイドライン

- コードと意味的に重複するコメントは書かない（DRY原則）
- コードからは意味的に読み取れない情報をコメントに書く：
  - そのコードが必要になった理由
  - 一見して好ましくない（非効率、長大、複雑など）コードを採用している理由
  - その他背景情報（GithubのIssue、PR、コメントへのリンクなど）

### パフォーマンス方針

- **測定主義**：主観ではなく客観的指標でパフォーマンスを評価する
- **基準値の設定**：以下の基準を目安とし、継続的に監視する
  - **WebアプリUI**：初回表示3秒以内、ページ遷移1秒以内、API応答平均500ms以内
  - **バックエンドAPI**：応答時間平均300ms以内、95%ile 1秒以内
  - **開発環境**：ビルド時間初回5分以内、増分30秒以内、テスト実行3分以内
- **最適化判断**：ユーザー体験 > 開発生産性 > 運用コスト の優先度で改善を判断する
- **測定ツール**：Lighthouse、APMツール、クエリログ等を活用した継続的監視
- **トレードオフ考慮**：開発工数とパフォーマンス改善効果を比較検討する

### Issue / PR の作成ルール

- Issue を作成する際は、`.github/ISSUE_TEMPLATE/` にあるテンプレートに従うこと。
- Pull Request を作成する際は、`.github/pull_request_template.md` に従うこと。
- テンプレートの各項目は空欄にせず、内容がない場合は「なし」と明記すること。
- 1 Issue = 1目的、1 PR = 1論点とする。

## 詳細: MAY（推奨）

### 意思決定と***ADR***

- 意思決定があった場合は、***ADR***（Architecture Decision Record）として必ず記録する。
- ***ADR***は `docs/adr` に配置する。
- フォーマットは `docs/adr/template.md` に従う。
- `docs/adr/README.md` の指示に従う。
- **ファイル命名規則**：
  - 1つの意思決定につき1ファイルを作成する。
  - ファイル名は `docs/adr/YYYYMMDD-タイトル.md` の形式とする。
  - 日付は決定日を `YYYYMMDD` 形式で記録する。
  - タイトルは小文字ケバブケースで簡潔に記述する。
  - 同日に複数の***ADR***を作る場合は連番を付与する。
    （例：`20250924-adopt-monorepo-structure.md`, `20250924-02-introduce-tdd.md`）

### リポジトリ構成

- 本リポジトリは monorepo 構成とする。
- `packages/` 以下に各パッケージを配置する。
- パッケージの責務境界は以下とする：
  - アプリケーション
  - e2eテスト
  - 共通設定（lint, formatter など）

### ディレクトリ構成の指針

- **関連ファイルの集約**：関連の強いファイル同士は近い場所に配置する。1つのファイルに対して関連の強いファイルが複数存在する場合は、サブディレクトリにまとめる

### Github Actions

- **再利用可能ワークフローの命名規則**：他のワークフローから呼び出される専用のワークフロー（`workflow_call` トリガーのみで単独実行されないもの）は、ファイル名の先頭にアンダーバー（_）を付ける。

### テスト手法

- **property-based test**：具体的な値に依存しないテストでは検討する
- **テスト技法**：各テスト対象・観点について、一般的なテスト技法に基づいてテストを設計することを推奨する：
  - 同値クラステスト
  - 境界値テスト
  - デシジョンテーブルテスト
  - 状態遷移テスト
  - ペア構成テスト

### テスト方針

#### テスト分析

- 各仕様について、テストするべき対象・観点を決定すること
- 例：認証画面の場合→正しい組み合わせでログインできるか、ログイン失敗時のメッセージは適切か

#### テスト設計

- 各テスト対象・観点について、一般的なテスト技法に基づいてテストを設計する

#### テスト実装

- 自動テストが適正と判断できるテストの場合はe2eテストとして実装する
- 自動テストが適正と判断できない場合は、テストの手順書を作成する
- 自動テストとして適正かどうかの判断は以下から判断する。コストが小さい場合はe2eテストとして実装する：
  - スクリプトの複雑さ
  - スクリプトの実行コスト
  - スクリプトのメンテナンスコスト
- 自動テストとして適正かどうかの判断は、最後に必ずレビューを受けること

### 監視・メトリクス方針

- **観測可能性の確保**：ログ、メトリクス、トレースの基本的な実装を行う
- **軽量性優先**：個人開発に適した最小限の設定で最大の効果を狙う
- **基本監視項目**：
  - **可用性**：アップタイム、ダウンタイム、ヘルスチェック（`/health`エンドポイント）
  - **性能**：レスポンス時間、エラー率、リソース使用量
  - **ユーザー体験**：Core Web Vitals（LCP、FID、CLS）
- **アラート設定**：ダウンタイム即座通知、エラー率5%超過、レスポンス時間95%ile > 2秒
- **ツール選択**：コスト効率重視、無料枠活用（Sentry、New Relic、Prometheus+Grafana等）
- **セキュリティ**：ログ・メトリクスから機微情報を除外、適切なアクセス制御

### その他のアーキテクチャ方針

以下の観点を重視する：

- **テスト容易性**
  - コントロールできない箇所は分離してテストできるようにする（例：外部サービス、外部API）
  - コントロールできる部分（個別の関数・オブジェクト、ローカルDBなど）は、分離する必要はない（例：e2eではローカルDBにseed値を投入して実行する。DBは分離しない）
- より安定したモジュールに依存させること（安定依存の原則：より多くのモジュールに依存されているモジュール）
- 具象モジュールよりも抽象モジュールへの依存を優先させること
- 変更の際は最小のモジュール数に閉じ、複数モジュールを横断的に変更する必要が無いように作ること

### 設計原則

- **低結合**：モジュール間の結合度が低い
- **高凝集**：モジュールごとに知識が集約されている
- **直交性**：モジュールが互いに独立している
- **可逆性**：設計上の決定を取りやめることができる（UI操作の取り消しとは異なる）
- **DRY原則**：重複を避けるのは「コード（テキスト単位）」ではなく「知識（意味的単位）」である
- **KISS原則**：複雑化を避ける
- **YAGNI**：事前のオーバーエンジニアリングを避ける

### その他の実装方針

- early return を活用する
- early return はエッジケースの排除に利用する
- 例：環境変数が不足している場合は、実行時ではなく起動時で検出できるようにする
- sample-based test で複数の値を検証する場合は parameterized testを使用する
- 実行時は、アプリ本体をビルドし dev サーバーで起動、その外部利用を通じてテストを行う。

## 詳細: NEVER（禁止）

- 本番環境や本番データに対する操作を行わない。
- Secrets、APIキー、認証情報を生成・出力しない。
- 外部コードやライブラリを無断で追加しない。
- 規約に従わない独自ルールを持ち込まない。
- main ブランチへ直接 push しない。
- セキュリティやライセンスに関わる変更を独断で行わない。

---

## セキュリティとコスト

- 規約に衝突がある場合は、**既存規約 > AGENTS.md > 一般慣習** の順で優先する。
- 出力や提案は、最小限の差分で可逆的（revert可能）であること。
- デフォルトで全権限を付与せず、必要な機能を実行するのに必要な権限のみを明示的に設定する。
- セマンティックバージョニングの場合は、メジャー・マイナー・パッチ番号すべてを具体的な数値で指定し、キャレット（^）やチルダ（~）などの範囲指定は使用しない（例：`"react": "18.2.0"` とし、`"react": "^18.0.0"` は使用しない）。
- これにより、単独実行可能なワークフローと再利用専用ワークフローを視覚的に区別する（例：`_common-build.yml`、`_deploy-template.yml`）。

---

## 簡潔チェックリスト

### 開発開始前

- [ ] 要件確認：日本語使用、***ADR***確認、***用語***統一（`docs/terms.md`）
- [ ] 設計方針：***UDD>DDD>TDD***、***可逆性***優先

### 実装中

- [ ] ***セキュリティ***：最小権限、機微情報保護、依存固定
- [ ] コード品質：***型安全性***、***構造化ログ***、***例外処理***
- [ ] ***アーキテクチャ***：ポリシー・実装分離、一方向依存
- [ ] ***パフォーマンス***：基準値監視、測定ツール設定

### 完了前

- [ ] ***テスト***：カバレッジ80%以上、全テスト通過
- [ ] 品質：型チェック・Lint通過
- [ ] ドキュメント：***ADR***作成、***用語***更新、手動テスト手順書
