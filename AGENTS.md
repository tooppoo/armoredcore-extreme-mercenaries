# AGENTS.md

## 前提

- ドキュメント・回答・コメントなど、すべてのやり取りは日本語を使用する。
- 出力は **Markdown形式** とする。
- コードやdiffを提示する場合も、必ずMarkdownコードブロックで囲む。
- 曖昧または矛盾する要求に対しては、推測で対応せず、**確認を求める**こと。

## 意思決定とADR

- 意思決定があった場合は、ADR（Architecture Decision Record）として必ず記録する。
- ADRは `docs/adr` に配置する。
- フォーマットは `docs/adr/template.md` に従う。
- `docs/adr/README.md` の指示に従う。
- **ファイル命名規則**：
  - 1つの意思決定につき1ファイルを作成する。
  - ファイル名は `docs/adr/YYYYMMDD-タイトル.md` の形式とする。
  - 日付は決定日を `YYYYMMDD` 形式で記録する。
  - タイトルは小文字ケバブケースで簡潔に記述する。
  - 同日に複数のADRを作る場合は連番を付与する。  
    （例：`20250924-adopt-monorepo-structure.md`, `20250924-02-introduce-tdd.md`）

## 用語の取り扱い

- プロジェクト固有の用語を導入する場合は、専用の用語集を作成すること。
- 用語集は `docs/terms.md` に配置する。
- ドキュメントやコメントで独自用語を使用する場合は、***太字斜体*** で装飾すること。
- 定義されていない用語を使う必要がある場合は、まず確認を求める。

## リポジトリ構成

- 本リポジトリは monorepo 構成とする。
- `packages/` 以下に各パッケージを配置する。
- パッケージの責務境界は以下とする：
  - アプリケーション
  - e2eテスト
  - 共通設定（lint, formatter など）

### ディレクトリ構成の指針

- **密結合原則**：関連の強いファイル同士は離れたディレクトリに配置せず、物理的に近い場所に配置する。
- **関連ファイルの集約**：1つのファイルに対して関連の強いファイルが複数存在する場合は、以下のルールに従ってサブディレクトリにまとめる：
  - サブディレクトリは元ファイルと同じディレクトリに配置する
  - サブディレクトリの名前は元ファイルと同じ名前とする（拡張子は除く）
  - 例：`user.service.ts` に関連するファイル群は `user.service/` ディレクトリに配置
- **関連性の判定基準**：ファイル間の関連性は以下の観点から判定する：
  - **意味的関連性**：ドメイン概念、ビジネスロジック、ユースケースレベルでの関連
  - **技術的関連性**：import/export関係、共通の依存関係、実装上の結合度
- **優先度**：意味的関連性は技術的関連性よりも常に優先する。ドメイン駆動設計の原則に従い、ビジネス概念の境界でディレクトリを分割することを重視する。

## 開発スタイル

### 基本開発スタイル

- 以下の開発スタイルを重視する：
  - TDD（Test-Driven-Development）
  - UDD（UseCase-Driven-Development）、特にドキュメンテーション
  - DDD（Domain-Driven-Design）、特にドキュメンテーション、アプリ設計、ディレクトリ構成、クラス・関数・モジュールの命名
- 開発スタイルが衝突した場合は、**UDD > DDD > TDD** の優先度で判断する。

### アーキテクチャ方針

以下の観点を重視する：

- **ポリシーと実装の分離**
  - ポリシー：ソフトウェア前提に依存する、各ロジックやモジュールのパラメータを決定する処理
  - 実装：個々の独立したロジック、モジュール
- **生成と実行の分離**
  - 生成：様々なロジック実行の主体となるオブジェクトの生成
  - 実行：生成されたオブジェクトを利用して、実際にロジックを実行する
- **テスト容易性**
  - コントロールできない箇所は分離してテストできるようにする（例：外部サービス、外部API）
  - コントロールできる部分（個別の関数・オブジェクト、ローカルDBなど）は、分離する必要はない（例：e2eではローカルDBにseed値を投入して実行する。DBは分離しない）
- **依存の方向**
  - 依存は常に一方向とすること。これはレイヤー間でも同様
  - 相互依存は禁止
  - より安定したモジュールに依存させること（安定依存の原則：より多くのモジュールに依存されているモジュール）
  - 具象モジュールよりも抽象モジュールへの依存を優先させること
- **開放閉鎖原則**
  - 各モジュールは、拡張が容易となるように作ること
  - 変更の際は最小のモジュール数に閉じ、複数モジュールを横断的に変更する必要が無いように作ること

### 設計方針

以下の観点を重視する：

- **低結合**：モジュール間の結合度が低い
- **高凝集**：モジュールごとに知識が集約されている
- **直交性**：モジュールが互いに独立している
- **可逆性**：設計上の決定を取りやめることができる（UI操作の取り消しとは異なる）
- **DRY原則**：重複を避けるのは「コード（テキスト単位）」ではなく「知識（意味的単位）」である
- **KISS原則**：複雑化を避ける
- **YAGNI**：事前のオーバーエンジニアリングを避ける
- **優先度**：`可逆性 > 低結合 = 高凝集 = 直交性 > KISS原則 = YAGNI > DRY原則`

### 実装方針

以下の観点を重視する：

- **Fail Fast**
  - 前提条件が満たされていないために失敗する時は、可能な限り素早くエラーにして発見を早める
  - 例：環境変数が不足している場合は、実行時ではなく起動時で検出できるようにする
- **少ない・浅い分岐**
  - 分岐はできるだけ減らし、コードが線形となるようにする
  - 分岐が深くなるのは避ける。early return を活用する
  - early return はエッジケースの排除に利用する
- **コメント**
  - コードと意味的に重複するコメントは書かない（DRY原則）
  - コードからは意味的に読み取れない情報をコメントに書く：
    - そのコードが必要になった理由
    - 一見して好ましくない（非効率、長大、複雑など）コードを採用している理由
    - その他背景情報（GithubのIssue、PR、コメントへのリンクなど）
- **例外処理**
  - エンドユーザーが自力で解決できない問題のみを例外とすること（例：DB接続エラー、メモリリーク、通信エラーなど）
  - エンドユーザーが自力で解決できる問題は、例外にしないこと（例：不正な入力値、許可されていないリソースへのアクセスなど）
  - エンドユーザーが自力で解決できる問題は、Result型などを用いて「例外」ではなく「失敗」として表現すること
  - 例外が発生した場合、errorまたはwarnのログとして出力すること
- **型レベルプログラミング**
  - 静的型解析が可能な場合
  - 入力値が適正かどうか、実行時ではなく型解析レベルで判定可能にする
  - [Parse, don't validate](https://lexi-lambda.github.io/blog/2019/11/05/parse-don-t-validate/)を原則とする
- **単体テスト**
  - property-based test を常に考慮する
    - 具体的な値に依存するテスト（境界値テストなど）は、sample-based testを使用する
    - 具体的な値に依存しないテストは、property-based testを検討する（必ずproperty-based testにする必要はない）
    - sample-based test で複数の値を検証する場合は parameterized testを使用する
  - 単体テストは実装と同じディレクトリに配置する。spec/ など別ディレクトリには分離しない
- **e2eテスト**
  - e2eテストは独立したパッケージとする。
  - 他パッケージからの import を禁止する。
  - 実行時は、アプリ本体をビルドし dev サーバーで起動、その外部利用を通じてテストを行う。

## ログ

- 構造化ログを用いること
- 構造化ログには不具合・障害調査にあたって必要とされる情報を含めること
- 構造化ログを出力する際、機微情報は決して含めないこと（例：認証情報、個人情報、金融データ、知的財産）
- ログレベルは以下に従うこと：
  - **info**：システムの正常動作における重要な出来事（例：サービスの起動・停止、バッチジョブの起動・終了、主要なAPIの呼び出し）
  - **debug**：開発者が特定機能やパスの実行経路を追跡するために有用な情報（例：メソッド呼び出しの前後状態、パラメータ、リクエスト/レスポンス本文）
  - **warn**：システム上期待された動作ではないが、処理は実行可能なもの（例：非推奨APIの呼び出し、リソースの閾値超過、期待しない入力値）
  - **error**：システム上期待された動作でなく、処理を中断させなくてはならないもの（例：未処理の例外発生、外部APIの呼び出しエラー）
  - **fatal**：システム上期待された動作ではなく、システム全体の動作を止めるもの（例：必須設定の取得失敗、必須DBへの接続失敗）

## テスト方針

### テスト分析

- 各仕様について、テストするべき対象・観点を決定すること
- 例：認証画面の場合→正しい組み合わせでログインできるか、ログイン失敗時のメッセージは適切か

### テスト設計

- 各テスト対象・観点について、一般的なテスト技法に基づいてテストを設計する：
  - 同値クラステスト
  - 境界値テスト
  - デシジョンテーブルテスト
  - 状態遷移テスト
  - ペア構成テスト

### テスト実装

- 自動テストが適正と判断できるテストの場合はe2eテストとして実装する
- 自動テストが適正と判断できない場合は、テストの手順書を作成する
  - 手順書は `docs/test` ディレクトリに作成する
- 自動テストとして適正かどうかの判断は以下から判断する。コストが小さい場合はe2eテストとして実装する：
  - スクリプトの複雑さ
  - スクリプトの実行コスト
  - スクリプトのメンテナンスコスト
- 自動テストとして適正かどうかの判断は、最後に必ずレビューを受けること
- 自動テストのカバレッジは80%以上を必ず維持し、90%以上を目標とする

## Issue / PR の作成ルール

- Issue を作成する際は、`.github/ISSUE_TEMPLATE/` にあるテンプレートに従うこと。
  - 機能追加・改修の場合は `feature.md`
  - バグ修正の場合は `bug.md`
- Pull Request を作成する際は、`.github/pull_request_template.md` に従うこと。
- テンプレートの各項目は空欄にせず、内容がない場合は「なし」と明記すること。
- 1 Issue = 1目的、1 PR = 1論点とする。

## セキュリティとコスト

- 不要な依存追加を禁止する。
- 規約に衝突がある場合は、**既存規約 > AGENTS.md > 一般慣習** の順で優先する。
- 出力や提案は、最小限の差分で可逆的（revert可能）であること。
- **最小権限の原則**を適用する：システム、アプリケーション、ユーザー、プロセス、ワークフローなど、あらゆるコンポーネントには必要最小限の権限のみを付与する。デフォルトで全権限を付与せず、必要な機能を実行するのに必要な権限のみを明示的に設定する。
- **依存バージョンの固定**：新しい依存を追加する際は、特定のバージョンを明示的に指定する。セマンティックバージョニングの場合は、メジャー・マイナー・パッチ番号すべてを具体的な数値で指定し、キャレット（^）やチルダ（~）などの範囲指定は使用しない（例：`"react": "18.2.0"` とし、`"react": "^18.0.0"` は使用しない）。

## Github Actions

- **再利用可能ワークフローの命名規則**：他のワークフローから呼び出される専用のワークフロー（`workflow_call` トリガーのみで単独実行されないもの）は、ファイル名の先頭にアンダーバー（_）を付ける。これにより、単独実行可能なワークフローと再利用専用ワークフローを視覚的に区別する（例：`_common-build.yml`、`_deploy-template.yml`）。

## やらないことリスト

- 本番環境や本番データに対する操作を行わない。
- Secrets、APIキー、認証情報を生成・出力しない。
- 外部コードやライブラリを無断で追加しない。
- 規約に従わない独自ルールを持ち込まない。
- main ブランチへ直接 push しない。
- セキュリティやライセンスに関わる変更を独断で行わない。
